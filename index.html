<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Mastery - ä¸»é¡µ</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav>
        <a href="index.html" class="active">ä¸»é¡µ</a>
        <a href="vocab.html">è¯æ±‡</a>
        <a href="speaking.html">å£è¯­</a>
        <a href="listening.html">å¬åŠ›</a>
        <a href="writing.html">å†™ä½œ</a>
        <a href="history.html">å†å²</a>
    </nav>
    <h1>English Mastery</h1>
    <div class="section">
        <h2>å­¦ä¹ è®¡åˆ’ (ç¬¬ <span id="dayNum"></span> å¤© / 180)</h2>
        <p>è¯æ±‡é‡: <span id="vocabCount">0</span> / 3000 | ç†Ÿç»ƒ: <span id="masteredCount">0</span></p>
        <progress id="vocabProgress" max="3000" value="0"></progress>
        <p>ä»Šæ—¥: <span id="date"></span> | è¿›åº¦: <span id="progress">0%</span> | æ—¶é•¿: <span id="timeSpent">0</span> åˆ†é’Ÿ</p>
        <p>é˜¶æ®µ: <span id="phase"></span></p>
        <button onclick="resetPlan()">é‡ç½®ä»Šæ—¥</button>
    </div>

    <!-- è¯æ±‡å­¦ä¹  -->
    <div class="section">
        <h2>è¯æ±‡å­¦ä¹  (35åˆ†é’Ÿ)</h2>
        <h3>ä»Šæ—¥æ–°è¯</h3>
        <div class="card-container" id="dailyWords"></div>
        <h3>å¤ä¹ æ—§è¯</h3>
        <div class="card-container" id="reviewList"></div>
    </div>

    <!-- å£è¯­ç»ƒä¹  -->
    <div class="section">
        <h2>å£è¯­ç»ƒä¹  (25åˆ†é’Ÿ)</h2>
        <ul id="dialogues"></ul>
        <audio id="recording" controls class="hidden"></audio>
        <button onclick="startRecording()">å¼€å§‹å½•éŸ³</button>
        <button onclick="stopRecording()">åœæ­¢å½•éŸ³</button>
        <button onclick="markSpeakingComplete()">æ ‡è®°å®Œæˆ</button>
    </div>

    <!-- å¬åŠ›ç»ƒä¹  -->
    <div class="section">
        <h2>å¬åŠ›ç»ƒä¹  (30åˆ†é’Ÿ)</h2>
        <p id="audioText"></p>
        <button onclick="speak(document.getElementById('audioText').textContent)">æ’­æ”¾éŸ³é¢‘</button>
        <div id="quiz"></div>
        <button onclick="checkQuiz()">æäº¤ç­”æ¡ˆ</button>
        <div id="quizResult" class="hidden"></div>
    </div>

    <!-- å†™ä½œç»ƒä¹  -->
    <div class="section">
        <h2>å†™ä½œç»ƒä¹  (30åˆ†é’Ÿ)</h2>
        <ol id="prompts"></ol>
        <textarea id="answers" placeholder="æ¯è¡Œè¾“å…¥ä¸€ä¸ªç­”æ¡ˆ"></textarea>
        <button onclick="checkAnswers()">æ ¸å¯¹</button>
        <div id="result" class="hidden"></div>
    </div>

    <p id="badge" class="badge"></p>

    <script src="scripts.js"></script>
    <script>
        let mediaRecorder, audioBlob;

        function updateUI() {
            const daily = getDailyContent();

            // æ›´æ–°è®¡åˆ’
            document.getElementById('vocabCount').textContent = vocab.length;
            document.getElementById('masteredCount').textContent = vocab.filter(w => w.mastery === 'mastered').length;
            document.getElementById('vocabProgress').value = vocab.length;
            document.getElementById('date').textContent = today;
            document.getElementById('dayNum').textContent = dayNum;
            const totalGoal = 20 + 5 + 3 + (daily.audio.quiz?.length || 0) + (daily.writing.prompts?.length || 0);
            const completed = Math.min(plan.review, 20) + plan.new + plan.speaking + plan.listening + plan.writing;
            document.getElementById('progress').textContent = totalGoal ? `${Math.round((completed / totalGoal) * 100)}%` : '0%';
            document.getElementById('timeSpent').textContent = plan.time;
            document.getElementById('phase').textContent = dayNum <= 60 ? "åŸºç¡€ (ç¬¬1-2æœˆ)" : dayNum <= 120 ? "ä¸­çº§ (ç¬¬3-4æœˆ)" : "å†²åˆº (ç¬¬5-6æœˆ)";
            document.getElementById('badge').textContent = completed >= totalGoal ? "ğŸ‰ ä»Šæ—¥å®Œæˆå¾½ç« ï¼" : "";

            // è¯æ±‡ - æ–°è¯
            const dailyList = document.getElementById('dailyWords');
            dailyList.innerHTML = '';
            daily.words.forEach(item => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <div class="card-inner">
                        <div class="card-front">${item.word}<br><button onclick="speak('${item.word}')">å‘éŸ³</button></div>
                        <div class="card-back">${item.phonetics}<br>${item.meaning}<br>${item.sentence}</div>
                    </div>`;
                div.onclick = (e) => { if (e.target.tagName !== 'BUTTON') div.classList.toggle('flipped'); };
                dailyList.appendChild(div);
                if (!vocab.some(v => v.text === item.word)) {
                    vocab.push({ text: item.word, phonetics: item.phonetics, meaning: item.meaning, sentence: item.sentence, mastery: 'learning', added: today });
                    plan.new = Math.min(plan.new + 1, 5);
                }
            });

            // è¯æ±‡ - å¤ä¹ 
            const reviewList = document.getElementById('reviewList');
            reviewList.innerHTML = '';
            const reviewWords = vocab.filter(w => w.added !== today).slice(0, 20);
            reviewWords.forEach(w => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <div class="card-inner">
                        <div class="card-front">${w.text}<br><button onclick="speak('${w.text}')">å‘éŸ³</button></div>
                        <div class="card-back">${w.phonetics}<br>${w.meaning}<br>${w.sentence}<br><select onchange="updateMastery('${w.text}', this.value)"><option value="learning" ${w.mastery === 'learning' ? 'selected' : ''}>å­¦ä¹ ä¸­</option><option value="mastered" ${w.mastery === 'mastered' ? 'selected' : ''}>ç†Ÿç»ƒ</option></select></div>
                    </div>`;
                div.onclick = (e) => {
                    if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'SELECT') {
                        div.classList.toggle('flipped');
                        if (w.mastery === 'learning' && !div.dataset.counted) {
                            plan.review = Math.min(plan.review + 1, 20);
                            div.dataset.counted = 'true';
                            saveData();
                            updateUI();
                        }
                    }
                };
                reviewList.appendChild(div);
            });

            // å£è¯­
            const dialogues = document.getElementById('dialogues');
            dialogues.innerHTML = daily.speaking.map(d => `
                <li>
                    <strong>Q:</strong> ${d.q} <button onclick="speak('${d.q}')">å‘éŸ³</button><br>
                    <strong>A:</strong> ${d.a} <button onclick="speak('${d.a}')">å‘éŸ³</button>
                </li>
            `).join('');

            // å¬åŠ›
            document.getElementById('audioText').textContent = daily.audio.text;
            const quiz = document.getElementById('quiz');
            quiz.innerHTML = daily.audio.quiz.map((q, i) => `
                <p>${q.q}</p>
                ${q.opts.map((opt, j) => `<label><input type="radio" name="q${i}" value="${j}"> ${opt}</label>`).join('<br>')}
            `).join('<br>');

            // å†™ä½œ
            const prompts = document.getElementById('prompts');
            prompts.innerHTML = daily.writing.prompts.map(p => `<li>${p}</li>`).join('');
            document.getElementById('answers').value = localStorage.getItem('writing') || '';

            saveData();
        }

        function resetPlan() {
            if (confirm('ç¡®å®šé‡ç½®ä»Šæ—¥è¿›åº¦å—ï¼Ÿ')) {
                history.push({ date: plan.date, progress: { ...plan } });
                plan = { date: today, review: 0, new: 0, speaking: 0, listening: 0, writing: 0, time: 0 };
                vocab.forEach(w => w.mastery = 'learning');
                localStorage.removeItem('writing');
                saveData();
                updateUI();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                const chunks = [];
                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(chunks, { type: 'audio/webm' });
                    document.getElementById('recording').src = URL.createObjectURL(audioBlob);
                    document.getElementById('recording').classList.remove('hidden');
                };
                document.querySelector('button[onclick="startRecording()"]').disabled = true;
                document.querySelector('button[onclick="stopRecording()"]').disabled = false;
            } catch (err) {
                alert('å½•éŸ³å¤±è´¥: ' + err.message);
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                document.querySelector('button[onclick="startRecording()"]').disabled = false;
                document.querySelector('button[onclick="stopRecording()"]').disabled = true;
            }
        }

        function markSpeakingComplete() {
            plan.speaking = 3;
            saveData();
            updateUI();
        }

        function checkQuiz() {
            const daily = getDailyContent();
            let correct = 0;
            daily.audio.quiz.forEach((q, i) => {
                const selected = document.querySelector(`input[name="q${i}"]:checked`);
                if (selected && parseInt(selected.value) === q.ans) correct++;
            });
            plan.listening = correct;
            document.getElementById('quizResult').innerHTML = `å¾—åˆ†: ${correct}/${daily.audio.quiz.length}`;
            document.getElementById('quizResult').classList.remove('hidden');
            saveData();
            updateUI();
        }

        function checkAnswers() {
            const daily = getDailyContent();
            const input = document.getElementById('answers').value.trim().split('\n');
            let correct = 0;
            let result = [];
            daily.writing.answers.forEach((ans, i) => {
                const userAns = input[i] ? input[i].trim() : '';
                if (userAns.toLowerCase() === ans.toLowerCase()) {
                    correct++;
                    result.push(`ç¬¬${i+1}é¢˜: æ­£ç¡®ï¼`);
                } else {
                    const tip = daily.writing.tip && daily.writing.tip[i] ? daily.writing.tip[i] : "è¯·æ£€æŸ¥è¯­æ³•å’Œè¯æ±‡ã€‚";
                    result.push(`ç¬¬${i+1}é¢˜: ä½ çš„ç­”æ¡ˆ "${userAns}" ä¸æ­£ç¡®ã€‚æ­£ç¡®ç­”æ¡ˆ: "${ans}"ã€‚æç¤º: ${tip}`);
                }
            });
            plan.writing = correct;
            document.getElementById('result').innerHTML = `å¾—åˆ†: ${correct}/${daily.writing.answers.length}<br>${result.join('<br>')}`;
            document.getElementById('result').classList.remove('hidden');
            localStorage.setItem('writing', input.join('\n'));
            saveData();
            updateUI();
        }

        function updateMastery(word, mastery) {
            const w = vocab.find(v => v.text === word);
            if (w) w.mastery = mastery;
            saveData();
            updateUI();
        }

        if (plan.date !== today) {
            history.push({ date: plan.date, progress: { ...plan } });
            resetPlan();
        }
        updateUI();

        document.querySelectorAll('nav a').forEach(link => {
            link.classList.toggle('active', link.href.includes(location.pathname));
        });
    </script>
</body>
</html>
